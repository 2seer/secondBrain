2022-05-30 10:43
## Chunking Note
---
aliases: ì²­í‚¹ ë…¸íŠ¸

tags: SP ë¶„ì„

---

## ë‚´ìš©
ì‚¬ìš© í•¨ìˆ˜ :  [[INSERT IGNORE]], [[ROW_COUNT()]], [[LAST_INSERT_ID()]], [[SELECT INTO]], [[INDEX HINT]], [[STRAIGHT_JOIN]]
```MySQL
-- ëŸ° íƒ€ì„ ì—ëŸ¬ ì¤‘ ë…¼ë¦¬ ì—ëŸ¬ë¡œ ë¶„ë¥˜í•  í•­ëª©ì„ í•„í„°ë§
IF v_int_error_no = 1451 AND v_txt_error_msg LIKE '%fk-tags_has_products-products' THEN -- parent row
	SET po_int_return = 170071;
	SET v_bit_write_exception_log = FALSE;

ELSEIF v_int_error_no = 1452 AND v_txt_error_msg LIKE '%fk-tags_has_product_packages-product_packages%' THEN -- child row
	SET po_int_return = 170072;
	SET v_bit_write_exception_log = FALSE;
END IF;

-- SKIP

SET v_iny_proc_step = 1;

INSERT IGNORE tags (tag_name) VALUES (pi_vch_tag_name);
# tag_nameì„ ë“±ë¡í•˜ê³  ë“±ë¡ì‹œ ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•œë‹¤.

# ë“±ë¡ì´ ë˜ì—ˆë‹¤ë©´
IF ROW_COUNT() = 1 THEN
	# í…Œì´ë¸”ì˜ ë§ˆì§€ë§‰ auto_increment ê°’ì„ ë¦¬í„´í•œë‹¤.
	SET v_inm_tag_id = LAST_INSERT_ID();
ELSE
	# tagê°’ì´ ì¡´ì¬í•œë‹¤ë©´ tag_idì˜ ê°’ì„ v_inm_tag_idì— ë‹´ëŠ”ë‹¤.
	SELECT tag_id
	INTO v_inm_tag_id
	FROM tags FORCE INDEX FOR JOIN (PRIMARY)
	# ì¸ë±ìŠ¤ë¥¼ íƒ€ì§€ ì•Šì„ ë•Œ ì¸ë±ìŠ¤ë¥¼ ê°•ì œë¡œ íƒ€ê²Œ í•œë‹¤.
	WHERE tag_name = pi_vch_tag_name;
END IF; 
    
# ì´ìƒì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì„

SET v_iny_proc_step = 2;
IF pi_vch_tag_purpose = 'product' THEN    
	INSERT tags_has_products (tag_id, product_id)
	VALUES (v_inm_tag_id, pi_int_reference_key);
	
	# ì™¼ìª½ í…Œì´ë¸”ì´ í•­ìƒ ì˜¤ë¥¸ìª½ í…Œì´ë¸”ë³´ë‹¤ ë¨¼ì € ì½í˜€ì§„ë‹¤ëŠ” ê±¸ ì œì™¸í•˜ê³ ëŠ” JOINê³¼ ìœ ì‚¬
	# JSON_OBJECT : JSON ì…ë ¥ì„ ì‰½ê²Œ í•´ì£¼ëŠ” í•¨ìˆ˜
	# JSON_ARRAYAGG : ì›í•˜ëŠ” í•­ëª©ì„ JSON ARRAYë¡œ ì¶”ì¶œí•˜ê³  JSON_OBJECTì™€ ê²°í•©í•´ì„œëŠ” ì›í•˜ëŠ” íƒ€ì…ì˜ JSON_ARRAYë¡œ ë³€í™˜ì´ ê°€ëŠ¥
	
	SELECT STRAIGHT_JOIN JSON_ARRAYAGG(JSON_OBJECT(
		  'tag_id', tag_has_products.tag_id
		, 'tag_name', t.tag_name
	))
	INTO v_jsn_tags
	FROM tags_has_products thp FORCE INDEX FOR JOIN(`nix-tags_has_products-product_id`)
		INNER JOIN tags t FORCE INDEX FOR JOIN(PRIMARY) ON t.tag_id = thp.tag_id
	WHERE thp.product_id = pi_int_reference_key;

	UPDATE products FORCE INDEX FOR JOIN (PRIMARY)
	SET tags = v_jsn_tags
	WHERE product_id = pi_int_reference_key;
ELSEIF pi_vch_tag_purpose = 'product_package' THEN

	INSERT tags_has_product_package (tag_id, product_package_id)
	VALUES (v_inm_tag_id, pi_int_reference_key);

	SELECT STRAIGHT_JOIN JON_ARRAYAGG(JSON_OBJECT(
		  'tag_id', tags_has_product_packages.tag_id
		 ,'tag_name', t.tag_name
	))
	INTO v_jsn_tags
	FROM tags_has_product_package thpp FORCE INDEX FOR JOIN(`nix-tags_has_product_packages-product_id`)
		INNER JOIN tags t FORCE INDEX FOR JOIN(PRIMARY) ON t.tag_id = thpp.tag_id
	WHERE thpp.product_package_id = pi_int_reference_key;

	UPDATE product_packages FORCE INDEX FOR JOIN (PRIMARY)
	SET tags = v_jsn_tags
	WHERE product_package_id = pi_int_reference_key;
END IF;
```

## â±íˆìŠ¤í† ë¦¬
	- 2022-05-30 10:43 ìµœì´ˆ ì‘ì„±


ğŸ“™ì¶œì²˜ :
URL :