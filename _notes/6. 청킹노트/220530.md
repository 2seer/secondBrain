2022-05-30 10:43
## Chunking Note
---
aliases: 청킹 노트

tags: SP 분석

---

## 내용
사용 함수 :  [[INSERT IGNORE]], [[ROW_COUNT()]], [[LAST_INSERT_ID()]], [[SELECT INTO]], [[INDEX HINT]], [[STRAIGHT_JOIN]]
```MySQL
-- 런 타임 에러 중 논리 에러로 분류할 항목을 필터링
IF v_int_error_no = 1451 AND v_txt_error_msg LIKE '%fk-tags_has_products-products' THEN -- parent row
	SET po_int_return = 170071;
	SET v_bit_write_exception_log = FALSE;

ELSEIF v_int_error_no = 1452 AND v_txt_error_msg LIKE '%fk-tags_has_product_packages-product_packages%' THEN -- child row
	SET po_int_return = 170072;
	SET v_bit_write_exception_log = FALSE;
END IF;

-- SKIP

SET v_iny_proc_step = 1;

INSERT IGNORE tags (tag_name) VALUES (pi_vch_tag_name);
# tag_name을 등록하고 등록시 오류는 무시한다.

# 등록이 되었다면
IF ROW_COUNT() = 1 THEN
	# 테이블의 마지막 auto_increment 값을 리턴한다.
	SET v_inm_tag_id = LAST_INSERT_ID();
ELSE
	# tag값이 존재한다면 tag_id의 값을 v_inm_tag_id에 담는다.
	SELECT tag_id
	INTO v_inm_tag_id
	FROM tags FORCE INDEX FOR JOIN (PRIMARY)
	# 인덱스를 타지 않을 때 인덱스를 강제로 타게 한다.
	WHERE tag_name = pi_vch_tag_name;
END IF; 
    
# 이상없는 것으로 보임

SET v_iny_proc_step = 2;
IF pi_vch_tag_purpose = 'product' THEN    
	INSERT tags_has_products (tag_id, product_id)
	VALUES (v_inm_tag_id, pi_int_reference_key);
	
	# 왼쪽 테이블이 항상 오른쪽 테이블보다 먼저 읽혀진다는 걸 제외하고는 JOIN과 유사
	# JSON_OBJECT : JSON 입력을 쉽게 해주는 함수
	# JSON_ARRAYAGG : 원하는 항목을 JSON ARRAY로 추출하고 JSON_OBJECT와 결합해서는 원하는 타입의 JSON_ARRAY로 변환이 가능
	
	SELECT STRAIGHT_JOIN JSON_ARRAYAGG(JSON_OBJECT(
		  'tag_id', tag_has_products.tag_id
		, 'tag_name', t.tag_name
	))
	INTO v_jsn_tags
	FROM tags_has_products thp FORCE INDEX FOR JOIN(`nix-tags_has_products-product_id`)
		INNER JOIN tags t FORCE INDEX FOR JOIN(PRIMARY) ON t.tag_id = thp.tag_id
	WHERE thp.product_id = pi_int_reference_key;

	UPDATE products FORCE INDEX FOR JOIN (PRIMARY)
	SET tags = v_jsn_tags
	WHERE product_id = pi_int_reference_key;
ELSEIF pi_vch_tag_purpose = 'product_package' THEN

	INSERT tags_has_product_package (tag_id, product_package_id)
	VALUES (v_inm_tag_id, pi_int_reference_key);

	SELECT STRAIGHT_JOIN JON_ARRAYAGG(JSON_OBJECT(
		  'tag_id', tags_has_product_packages.tag_id
		 ,'tag_name', t.tag_name
	))
	INTO v_jsn_tags
	FROM tags_has_product_package thpp FORCE INDEX FOR JOIN(`nix-tags_has_product_packages-product_id`)
		INNER JOIN tags t FORCE INDEX FOR JOIN(PRIMARY) ON t.tag_id = thpp.tag_id
	WHERE thpp.product_package_id = pi_int_reference_key;

	UPDATE product_packages FORCE INDEX FOR JOIN (PRIMARY)
	SET tags = v_jsn_tags
	WHERE product_package_id = pi_int_reference_key;
END IF;
```

## ⏱히스토리
	- 2022-05-30 10:43 최초 작성


📙출처 :
URL :